---
title: 'Practical 4: Analysis of geostatistical data'
fontsize: 11pt
date: "March 11, 2019"
output:
  html_document:
    df_print: paged
  pdf_document: default
geometry: margin=1in
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE,
                      fig.width=7, fig.height=4)
```


This practical uses the data from Diggle et al. (2002) concerning a study in the Gambia that
was designed to assess the effectiveness of the National Impregnated Bednet Programme in
reducing child morbidity and mortality from malaria. Data were collected on 2035 children
living in 65 different villages in the Gambia. Blood samples were taken for each child and
measured for the presence of malarial parasites. Covariate data included the child's age,
whether or not they regularly slept under a bed net, and if so, whether this was treated
(with permethrin insecticide). Two village-level covariates were also measured: an indicator
of whether the village belonged to the Primary Health Care system, and a measure of the
greenness of the village environment.

Reference 
Diggle, P., Moyeed, R., Rowlingson, B. & Thomson, M. (2002). Childhood malaria in The Gambia: a case-study in model-based geostatistics, Applied Statistics, 51:493-506



These data are freely available from the `geoR` pacakge.
For this practical, the data are collected in a `.RData` file called `gambia_data.RData`.

The  `gambia_data.RData` file includes a set of objects:
+ `M` = 2035 children 
+ `N` = 65 villages 

+ `gambia` is a  `data.frame` that includes the following 7 variables:

`x` = x-coordinate of the village (UTM)

`y` = y-coordinate of the village (UTM)

`pos`= presence (1) or absence (0) of malaria in a blood sample taken from the child

`age`	is age of the child, in days

`bednet`is the bed net use and is in 3 categories:
	1 = doesn't sleep under bed net
	2 = sleeps under untreated bed net
	3 = sleeps under bed net impregnated with permethrin insecticide
	
`green`	is a continuous measure of greenness of the village environment

`phc`		is a binary indicator: 1/0 = village does/doesn't belong to Primary Health Care system


+ `gambia_data.RData` includes also an indicator variable (between 1 and 65) called `village` indicating which village the children live in.


In this practical we will assess if sleeping under bed nets reduce risk of malaria. 
Also we are interested in evaluating if other child or village level covariates help explain risk of malaria and if there is evidence of spatial structure in the between-village variation which would indicate partly an environmental explanation.


# Before starting the practical

Organise your work:

* Create a separate subdirectory in your home directory to save your files created during this practical (e.g. "C:/SpatialAnalysis2019/Practicals/Practical4").

* Copy all the files from the blackboard to your subdirectory (created just above). 

* You will use the following R packages: geoR, sp, rgdal, dplyr, leaflet, akima, RColorBrewer, R2OpenBUGS, mcmcplots.

* If not installed yet, then install the required packages using the function `install.packages()` 

* Then, load needed libraries:
```{r echo=TRUE, eval = TRUE, message=FALSE}
library(geoR)        
library(sp) 
library(rgdal) 
library(dplyr)
library(leaflet)
library(akima)
library(RColorBrewer)

library(R2OpenBUGS)  
library(mcmcplots)    
```


## Data

* Load the data in `R` 

```{r eval=TRUE, echo=TRUE, message=FALSE}
load(file="gambia_data.RData")
```


* Print the first rows of the data.frame object `gambia`

```{r eval=TRUE, echo=TRUE, message=FALSE}
head(gambia)
```


* Create a data.frame object that includes all the data in the data.frame `gambia`  + the indicator variable `village` and produce the summary statistics of these data 

```{r eval=TRUE, echo=TRUE, message=FALSE}
gambia <- as.data.frame(cbind(gambia,village))
summary(gambia)
```

* Compute the overall proportion (prevalence) of children with malaria. To do so, we can use the pacakage `dplyr`
```{r eval=TRUE, echo=TRUE, message=FALSE}
prop <- with(gambia, table(pos)) %>% prop.table()
prop
prop*100
```

* The age is in days. We want to compute the age in years, then generate a new variable that classifies the age in classes as follows: 1=0 to 2 yrs, 2=2 to 3 yrs, 3=3 to 4 yrs, 4=4 to 5 yrs.

```{r eval=TRUE, echo=TRUE, message=FALSE}
# age in years
gambia$age.y <- round(gambia$age/365, 0)
summary(gambia$age.y)

# age in classes
gambia$agecat[gambia$age.y < 2] <- 1
gambia$agecat[gambia$age.y >=2 & gambia$age.y <3] <- 2
gambia$agecat[gambia$age.y >=3 & gambia$age.y <4] <- 3
gambia$agecat[gambia$age.y >=4] <- 4
```

*  Calculate the prevalence of children infeccted in each village. To do so, we can use again the pacakage `dplyr` and compute the proportion of positive tests: number of positive results divided by the total number of tests in each village, moltiplied by 100.

```{r eval=TRUE, echo=TRUE, message=FALSE}
prev <- group_by(gambia, x, y) %>% 
        summarize(total = n(),
        positive = sum(pos),
        prev = (positive/total)*100)
prev <- as.data.frame(prev)
```


* Plot the malaria prevalence in a `leaflet` map.
Leaflet is an open source JavaScript library used to built interactive web mapping applications.
It expects that the geographical coordinates are expressed in latitude and longitude.
Because Gambia coordinates in our dataset are in UTM (Universal Transverse Mercator) format, we need to 
reproject them.
The following code is exctracted from Paula Moraga github page.
Proceed with the following the steps:

(a) Transform the coordinates. 
We transform the UTM coordinates (easting/northing) into geographic coordinates latitude/longitude using the  `spTransform()` function of the `sp` package.
First, we create a SpatialPoints object called `sp.points` using the `sp` package where we specify the projection of The Gambia, that is, UTM zone 28. 
Then, we transform the UTM coordinates in `sp.points` to geographic coordinates using `spTransform()` where we set coordinate reference systems (CRS) to `CRS("+proj=longlat +datum=WGS84")`

```{r eval=TRUE, echo=TRUE, message=FALSE}
sp.points  <- SpatialPoints(prev[, c("x", "y")], proj4string = CRS("+proj=utm +zone=28"))
sp.LongLat <- spTransform(sp.points, CRS("+proj=longlat +datum=WGS84"))
```

(b) Then, we add the longitude and latitude variables to the data frame *prev*:

```{r eval=TRUE, echo=TRUE, message=FALSE}
prev[, c("long", "lat")] <- coordinates(sp.LongLat)
head(prev)
```

(c) Map the malaria prevalence with the location of the villages using the `leaflet()`. 
We use `addCircles()` to put circles on the map, and colour circles according to the value of the prevalences. We choose a palette function with colours from `viridis` and four equal intervals from values 0 to 100. We use the base map given by `providers$CartoDB.Positron` so point colours can be distinguised from the background map. We also add a scale bar using `addScaleBar()`.

```{r eval=TRUE, echo=TRUE, message=FALSE}
pal <- colorBin("viridis", bins = c(0, 25, 50, 75, 100))
leaflet(prev) %>%  addProviderTiles(providers$CartoDB.Positron) %>%
  addCircles(lng = ~long, lat = ~lat, color = ~pal(prev)) %>%
  addLegend("bottomright", pal = pal, values = ~prev, title = "Prevalence") %>%
  addScaleBar(position = c("bottomleft"))
```

* Now, we plot the prevalence of children with malaria in the villages by filling the gaps in the plot to get a nice continuous surface of data. So we need to interpolate. To do so, we can use the package `akima` (spline interpolation).
For the color, we can use the package `RColorBrewer` (optional).
In addition, we save the the plot as a `.jpg` object.

```{r eval=TRUE, echo=TRUE, message=FALSE}
jpeg(file="MapInt.jpg")
int.malaria <- interp(x=prev$x, y=prev$y, prev$prev)
image(int.malaria, xlim=range(prev$x),ylim=range(prev$y), col=brewer.pal(8,"PuOr"))
# image(int.malaria, xlim=range(prev$x),ylim=range(prev$y)) # without RColorBrewer
contour(int.malaria, add=T)
points(prev[,1], prev[,2])
dev.off()
```

Note: For alternatives to the `akima` package, see the Bivand and Gebhardt post `https://www.user2017.brussels/uploads/bivand_gebhardt_user17_a0.pdf`


* Compute the village coordinates **in Km** and save it as a separate object called `coords`. 

```{r eval=TRUE, echo=TRUE, message=FALSE}
coords <- as.matrix(prev[,1:2])/1000 # in km
```


* Compute the matrix of the distances between village and call it as `distance`

```{r eval=TRUE, echo=TRUE, message=FALSE}
distance <- dist(coords)
```

* Describe the range (min and max) of the distances 

```{r eval=TRUE, echo=TRUE, message=FALSE}
min(distance[which(distance>0)])
max(distance)
```
The minimum distance between the villages is 0.95 km and the maximum distance is 273.3 km.

Alternatively, you could use the `rgeos` pacakge to compute the distance:

```{r eval=TRUE, echo=TRUE, message=FALSE}
library(rgeos)
sp1 <- SpatialPoints(coords = coords) # from sp package
distMat <- gDistance(sp1,sp1, byid = TRUE)
min(distMat[which(distMat>0)])
max(distMat)
```



### Spatial model

We now fit a spatial model to the Gambia malaria data. We use the `spatial.exp` distribution for the random effects which fits a multivariate Normal with covariance matrix proportional to an exponential function of distance.

* Open and edit the model *Model_Gambia_Sp.txt*.

See Lecture 4 for tips on coding categorical covariates in OpenBUGS, and specifying initial values for the corresponding regression coefficients. In particular, include statements in your model code to calculate:

(a)	the baseline prevalence on malaria (i.e. in children with baseline values of all the covariates)

(b)	the odds ratio of malaria associated with each covariate (i.e. the exponential of each regression coefficient)

(c) the posterior probabilities that untreated bed net use reduces the odds of malaria relative to untreated bed net use (think carefully about how to calculate the latter, it is a function of the difference between two regression coefficients).

(d)	Include a statement in your model code to calculate the correlation in residual log odds of malaria between villages 1 km apart (remember that the correlation is given by `exp(-phi*d)` where here `d` is distance in metres).


* Now run the model in `OpenBUGS` via `R`. To do so, follow the steps:

1. Prepare the list of data and call it `DataGambia`(note: for the age variable, use age in categories)

```{r echo=TRUE, eval=TRUE, include=TRUE}
DataGambia <- list("M"=M, "N"=N,"O"=gambia$pos, 
               "age"=gambia$agecat, "bednet"=gambia$bednet,"green"=gambia$green,
               "phc"=gambia$phc,
               "village"=gambia$village, "x"=prev$x,"y"=prev$y) 
```


2. Prepare the list of initial values for the spatial model

```{r echo=TRUE, eval=TRUE, include=TRUE}
inits <- list(
list(alpha = -0.51, beta.age = c(NA, 0.83, 0.28, -1.68), beta.bednet = c(NA, 
-2.41, 0.68), beta.green = -0.23, beta.phc = 1.82, w = rep(0.1, 65), v2.inv = 1,
    range=7), # chain 1
list(alpha = 1.29, beta.age = c(NA, 0.49, -0.38, -0.04), beta.bednet = c(NA, 
6.85, 0.09), beta.green = 2.66, beta.phc = -0.31, w = rep(0.01, 65), v2.inv = 0.1, 
range=30) # chain 2
)
```

3.	Prepare the set of parameters to be monitored

```{r echo=TRUE, eval=TRUE, include=TRUE}
parameters <- c("alpha","beta.age","beta.bednet","beta.green","beta.phc", 
                "OR.age","OR.bednet","OR.green","OR.phc","baseline.prev", 
                "PP.treated", "PP.untreated","OR.village",
                "v2.inv","phi","w", "corr.1km")
```


4.	Prepare the MCMC setting. Here, we say we want to run two chains for 6,000 iterations, discarding the first 3,000 values, and thinning the remaining values by 10.

```{r eval=TRUE, echo=TRUE}
ni <- 6000  # nb iterations 
nt <- 10    # thinning interval
nb <- 3000  # nb iterations as burn-in 
nc <- 2     # nb chains
```

5. Run the model using the function `bugs()`

```{r eval=TRUE, echo=TRUE}
modelgambia.sim <- bugs(data = DataGambia, parameters = parameters, 
                     inits = inits, 
                     model.file = "Model_Gambia_Sp.txt",
                     n.chains = nc, n.iter = ni, n.burnin = nb, 
                     n.thin = nt, debug = FALSE, 
                     working.directory = getwd(), 
                     codaPkg = FALSE, summary.only = FALSE,
                     bugs.seed = 5)
```

* Visualise the main diagnostic plots using `mcmcplot`.

```{r eval=FALSE, echo=TRUE}
mcmcplot(modelgambia.sim, random=3)
```


* Obtain the posterior summary statistics of the parameters monitored 

```{r eval=TRUE, echo=TRUE}
print(modelgambia.sim, digits = 2)
```

* Inspect the Rhat (the potential scale reduction factor) from the posterior summary statistics and discuss it (remember from previous practical that a Rhat close to 1.0 for all parameters indicates a good mixing. If we find values higher than the 1.1 threshold, we should increase the nb of iterations).


* What do you conclude regarding the inclusion of the variable "presence of primary health care (phc) system" in relationship to the prevalence of malaria? Suggestion: check the coefficient `beta.phc` 

ANSWER: The inclusion in the PHC system doesn't appear markedly to affect the prevalence of malaria, as the 95% posterior interval comfortably straddles zero (posterior mean is -0.34, 95%CI: -0.87 to 0.18)


* Report the estimated `OR` for age and the associated 95% credible intervals (CI) , **with respect to the reference category**. What is your conclusion about its effect? 

ANSWER: 

OR 0-2yrs 	1.00

OR 2-3 yrs 2.20 (95%CI: 1.47 to 3.20)

OR 3-4 yrs 2.82 (95%CI: 1.88 to 4.04)

OR 4-5 yrs 3.17 (95%CI: 2.16 to 4.51)

There is a progressive increase in prevalence of malaria with age. 


* What is the baseline prevalence of malaria?

ANSWER:

The baseline prevalence is 0.30 (95%CI: 0.19 to 0.42)


* Report the estimated OR of malaria (and the associated 95% credible intervals (CI)) for children sleeping under untreated bed nets vs no bed net (the latter is the reference cathegory). 

ANSWER:

OR no bed net          1.00

OR bed net untreated   0.65 (95%CI: 0.47 to 0.88)


* Report the estimated OR of malaria (and the associated 95% credible intervals (CI)) for children sleeping under treated vs untreated bed nets. Discuss the results 
  

ANSWER:

The results show that children sleeping under treated bed nets have a lower risk of malaria. 
The estimated OR is 0.69 (95%CI: 0.45 to 1.02)


* What is the estimated posterior mean of the correlation between villages at 1 km?

ASWER:

The estimated correlation is 0.95, with 95%CI 0.66 to 0.99


#### Spatial prediction

Now, we predict the probability of infection status of a child, with covariates at the **baseline levels**, at the following location: (x,y) = (493.3000, 1505.000). 

* Edit the *Model_Gambia_Sp.txt* to specify all the statements to predict the infection status at the new location. To do so, use the function `spatial.unipred` implemented in OpenBUGS, which uses kriging to interpolate spatial random effects. The function `spatial.unipred` carries out single site prediction.
To edit the model code, check the **GeoBugs user manual** directly from `OpenBUGS` or from the [link] (https://www.mrc-bsu.cam.ac.uk/wp-content/uploads/geobugs12manual.pdf). Call the edited model as *Model_Gambia_SpPred.txt*

* Run the model, specifing the NEW lists of data, initial values and parameters, to obtain the requested prediction. Use the same set of MCMC as previously specified. Suggestion: specify the coordinates of the new location in the data list as `"x0"=493.3000` and `"y0"=1505.000`. 
Note that the model is computationally demanding and will take about 15 min to run in BUGS.

```{r eval=TRUE, echo=TRUE}

DataGambiaPred <- list("M"=M, "N"=N,"O"=gambia$pos, 
               "age"=gambia$agecat, "bednet"=gambia$bednet,"green"=gambia$green,
               "phc"=gambia$phc,
               "village"=gambia$village, "x"=prev$x,"y"=prev$y, "x0"=493.3000,"y0"=1505.000) 


initsPred <- list(
list(alpha = -0.51, beta.age = c(NA, 0.83, 0.28, -1.68), beta.bednet = c(NA, 
-2.41, 0.68), beta.green = -0.23, beta.phc = 1.82, w = rep(0.1, 65), v2.inv = 1, 
    range=7, ypred=0, w0=0), # chain 1
list(alpha = 1.29, beta.age = c(NA, 0.49, -0.38, -0.04), beta.bednet = c(NA, 
6.85, 0.09), beta.green = 2.66, beta.phc = -0.31, w = rep(0.01, 65), v2.inv = 0.1, 
range=30, ypred=1, w0=0.1) # chain 2
)

parametersPred <- c("alpha","beta.age","beta.bednet","beta.green","beta.phc", 
                "OR.age","OR.bednet","OR.green","OR.phc","baseline.prev", 
                "PP.treated", "PP.untreated","OR.village",
                "v2.inv","phi","w", "corr.1km","w0","p0")



modelgambia.simPred <- bugs(data = DataGambiaPred, parameters = parametersPred, 
                     inits = initsPred, 
                     model.file = "Model_Gambia_SpPred.txt",
                     n.chains = nc, n.iter = ni, n.burnin = nb, 
                     n.thin = nt, debug = FALSE, 
                     working.directory = getwd(), 
                     codaPkg = FALSE, summary.only = FALSE,
                     bugs.seed = 5)

```

* What is the predicted probability of infection for a child at the new location?

```{r eval=TRUE, echo=TRUE}
print(modelgambia.simPred, digits = 2)
```

ANSWER:

The predicted probability is 0.32, 95%CI 0.06 to 0.73